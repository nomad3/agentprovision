# ServiceTsunami MCP Server - Data Integration + Web Scraping
nameOverride: "servicetsunami-mcp"
fullnameOverride: "servicetsunami-mcp"

image:
  repository: gcr.io/ai-agency-479516/servicetsunami-mcp
  tag: latest
  pullPolicy: IfNotPresent

replicaCount: 1

container:
  port: 8086
  command: ["python", "-m", "src.server"]

# Service account with Workload Identity for GCP services
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: dev-backend-app@ai-agency-479516.iam.gserviceaccount.com

# Pod security - runs as non-root mcpuser (UID 2001)
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 2001
  runAsGroup: 2001
  fsGroup: 2001

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false  # Playwright needs write access for browser cache
  capabilities:
    drop:
      - ALL

# Resource allocation - Playwright needs more memory than typical services
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 1500m
    memory: 2Gi

# Health checks
livenessProbe:
  enabled: true
  httpGet:
    path: /servicetsunami/v1/health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /servicetsunami/v1/health
    port: http
  initialDelaySeconds: 15
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /servicetsunami/v1/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8086

# ConfigMap with non-sensitive configuration
configMap:
  enabled: true
  data:
    FASTMCP_HOST: "0.0.0.0"
    FASTMCP_PORT: "8086"
    MCP_PORT: "8086"
    DATABRICKS_HOST: ""
    DATABRICKS_CATALOG_PREFIX: "tenant_"
    BROWSER_HEADLESS: "true"
    BROWSER_TIMEOUT: "30000"
    SCRAPE_MAX_RESULTS: "10"
    DATABASE_HOST: "localhost"
    DATABASE_PORT: "5432"
    DATABASE_NAME: "servicetsunami"

# External Secrets - pulls from GCP Secret Manager
externalSecret:
  enabled: true
  refreshInterval: 1m
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: servicetsunami-mcp-secret
    creationPolicy: Owner
  data:
    - secretKey: MCP_API_KEY
      remoteRef:
        key: servicetsunami-mcp-api-key
    - secretKey: DATABRICKS_TOKEN
      remoteRef:
        key: servicetsunami-databricks-token
    - secretKey: DATABASE_URL
      remoteRef:
        key: servicetsunami-database-url

# Cloud SQL Proxy sidecar for secure database connection
extraContainers:
  - name: cloud-sql-proxy
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
    args:
      - "--private-ip"
      - "--structured-logs"
      - "--port=5432"
      - "--http-port=9090"
      - "ai-agency-479516:us-central1:dev-postgres-instance"
    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

# Temporary directories (Playwright browser cache, screenshots)
tmpDirs:
  - /tmp

# HPA disabled - single replica
autoscaling:
  enabled: false

# PDB disabled with 1 replica
podDisruptionBudget:
  enabled: false

# Disable individual Ingress - using shared kubernetes/ingress.yaml
ingress:
  enabled: false
