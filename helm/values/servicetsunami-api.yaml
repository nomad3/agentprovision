# ServiceTsunami API Service - FastAPI Backend
nameOverride: "servicetsunami-api"
fullnameOverride: "servicetsunami-api"

image:
  repository: gcr.io/ai-agency-479516/servicetsunami-api
  tag: latest
  pullPolicy: IfNotPresent

replicaCount: 1

container:
  port: 8000

# Service account with Workload Identity for GCP services
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: dev-backend-app@ai-agency-479516.iam.gserviceaccount.com

# Pod security - Python app runs as non-root
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Resource allocation - minimal for cost savings
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Health checks for FastAPI
livenessProbe:
  enabled: true
  httpGet:
    path: /api/v1/
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /api/v1/
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /api/v1/
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8000
  annotations:
    cloud.google.com/backend-config: '{"default": "servicetsunami-api-backend"}'

# ConfigMap with non-sensitive configuration
configMap:
  enabled: true
  data:
    ALGORITHM: "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: "30"
    TEMPORAL_NAMESPACE: "default"
    DEFAULT_WORKFLOW_TIMEOUT_SECONDS: "600"
    MCP_ENABLED: "true"
    DATABRICKS_SYNC_ENABLED: "true"
    DATABRICKS_AUTO_SYNC: "true"
    DATABRICKS_RETRY_ATTEMPTS: "3"
    DATABRICKS_RETRY_INTERVAL: "300"
    LLM_MODEL: "claude-3-haiku-20240307"
    LLM_MAX_TOKENS: "4096"
    LLM_TEMPERATURE: "0.7"
    DATA_STORAGE_PATH: "/app/storage"
    ADK_BASE_URL: "http://servicetsunami-adk"

# External Secrets - pulls from GCP Secret Manager
externalSecret:
  enabled: true
  refreshInterval: 1m
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: servicetsunami-api-secret
    creationPolicy: Owner
  data:
    - secretKey: SECRET_KEY
      remoteRef:
        key: servicetsunami-secret-key
    - secretKey: DATABASE_URL
      remoteRef:
        key: servicetsunami-database-url
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: servicetsunami-anthropic-api-key
    - secretKey: MCP_API_KEY
      remoteRef:
        key: servicetsunami-mcp-api-key
    - secretKey: API_INTERNAL_KEY
      remoteRef:
        key: servicetsunami-api-internal-key
    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: servicetsunami-encryption-key

# Additional environment variables
env:
  - name: TEMPORAL_ADDRESS
    value: "temporal:7233"
  - name: MCP_SERVER_URL
    value: "http://mcp-server:8000"

# Horizontal Pod Autoscaler - disabled for cost savings
autoscaling:
  enabled: false

# Pod Disruption Budget - disabled with 1 replica
podDisruptionBudget:
  enabled: false

# Persistent storage for datasets
persistence:
  enabled: true
  storageClass: standard-rwo
  accessModes:
    - ReadWriteOnce
  size: 50Gi

# Temporary directories
tmpDirs:
  - /tmp

# Init container to wait for dependencies
initContainers:
  - name: wait-for-db
    image: busybox:1.36
    command: ['sh', '-c', 'echo "Waiting for database..."; sleep 10']
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

# Cloud SQL Proxy sidecar for secure database connection
extraContainers:
  - name: cloud-sql-proxy
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
    args:
      - "--private-ip"
      - "--structured-logs"
      - "--port=5432"
      - "--http-port=9090"
      - "ai-agency-479516:us-central1:dev-postgres-instance"
    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

# GKE Health Check Policy
healthCheckPolicy:
  enabled: true
  config:
    type: HTTP
    httpHealthCheck:
      port: 8000
      requestPath: /api/v1/

# Disable HTTPRoute and individual Ingress - using shared Ingress
httpRoute:
  enabled: false

# Individual Ingress disabled - using shared kubernetes/ingress.yaml
ingress:
  enabled: false

# Managed Certificate disabled - using shared certificate
managedCertificate:
  enabled: false
