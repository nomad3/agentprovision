# ServiceTsunami Orchestration Worker - Temporal Worker for Task Execution
nameOverride: "servicetsunami-orchestration-worker"
fullnameOverride: "servicetsunami-orchestration-worker"

image:
  repository: gcr.io/ai-agency-479516/servicetsunami-api
  tag: latest
  pullPolicy: IfNotPresent

replicaCount: 1

container:
  port: 8000
  command:
    - python
    - -m
    - app.workers.orchestration_worker

# Service account with Workload Identity
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: servicetsunami-worker@ai-agency-479516.iam.gserviceaccount.com

# Pod security
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Resource allocation for orchestration tasks
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Disable HTTP probes - worker doesn't serve HTTP
livenessProbe:
  enabled: false

readinessProbe:
  enabled: false

# Service not needed for worker
service:
  type: ClusterIP
  port: 80
  targetPort: 8000

# ConfigMap with non-sensitive configuration
configMap:
  enabled: true
  data:
    TEMPORAL_NAMESPACE: "default"
    DEFAULT_WORKFLOW_TIMEOUT_SECONDS: "600"

# External Secrets - same as API service
externalSecret:
  enabled: true
  refreshInterval: 1m
  secretStoreRef:
    name: gcpsm-secret-store
    kind: SecretStore
  target:
    name: servicetsunami-orchestration-worker-secret
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: servicetsunami-database-url
    - secretKey: MCP_API_KEY
      remoteRef:
        key: servicetsunami-mcp-api-key
    - secretKey: API_INTERNAL_KEY
      remoteRef:
        key: servicetsunami-api-internal-key

# Additional environment variables
env:
  - name: TEMPORAL_ADDRESS
    value: "temporal:7233"
  - name: MCP_SERVER_URL
    value: "http://mcp-server:8000"

# No autoscaling - single instance
autoscaling:
  enabled: false

# Persistent storage for datasets (shared with API)
persistence:
  enabled: true
  storageClass: standard-rwo
  accessModes:
    - ReadWriteOnce
  size: 50Gi

# Temporary directories
tmpDirs:
  - /tmp

# Init container to wait for Temporal
initContainers:
  - name: wait-for-temporal
    image: busybox:1.36
    command: ['sh', '-c', 'echo "Waiting for Temporal..."; sleep 15']
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

# No HTTPRoute - internal service only
httpRoute:
  enabled: false
