name: Deploy Kubernetes Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - staging
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

env:
  GCP_PROJECT: ${{ vars.GCP_PROJECT }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  GKE_CLUSTER: ${{ vars.GKE_CLUSTER }}
  GKE_ZONE: ${{ vars.GKE_ZONE }}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'prod' }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Create global IP address (if not exists)
        run: |
          if ! gcloud compute addresses describe servicetsunami-gateway-ip --global --project=${{ env.GCP_PROJECT }} 2>/dev/null; then
            echo "Creating global IP address..."
            gcloud compute addresses create servicetsunami-gateway-ip --global --project=${{ env.GCP_PROJECT }}
          else
            echo "Global IP address already exists"
          fi

          GATEWAY_IP=$(gcloud compute addresses describe servicetsunami-gateway-ip --global --project=${{ env.GCP_PROJECT }} --format='value(address)')
          echo "Gateway IP: $GATEWAY_IP"
          echo "GATEWAY_IP=$GATEWAY_IP" >> $GITHUB_ENV

      - name: Deploy Namespaces
        run: |
          echo "Deploying namespaces..."
          kubectl apply -f kubernetes/namespaces/
          kubectl apply -f kubernetes/gateway/namespace.yaml

      - name: Deploy Gateway
        run: |
          echo "Deploying Gateway API resources..."
          kubectl apply -f kubernetes/gateway/gateway.yaml
          kubectl apply -f kubernetes/gateway/reference-grant.yaml
          kubectl apply -f kubernetes/gateway/managed-certificate.yaml

      - name: Install External Secrets Operator (if not installed)
        run: |
          if ! helm status external-secrets -n external-secrets 2>/dev/null; then
            echo "Installing External Secrets Operator..."
            helm repo add external-secrets https://charts.external-secrets.io
            helm repo update
            helm install external-secrets external-secrets/external-secrets \
              --namespace external-secrets \
              --create-namespace \
              --set installCRDs=true \
              --wait
          else
            echo "External Secrets Operator already installed"
          fi

      - name: Deploy External Secrets Configuration
        run: |
          if [ -d "kubernetes/external-secrets" ]; then
            echo "Deploying External Secrets configuration..."
            # Replace placeholder values
            sed -i 's/YOUR_GCP_PROJECT/${{ env.GCP_PROJECT }}/g' kubernetes/external-secrets/*.yaml
            sed -i 's/YOUR_GCP_REGION/${{ env.GCP_REGION }}/g' kubernetes/external-secrets/*.yaml
            sed -i 's/YOUR_GKE_CLUSTER/${{ env.GKE_CLUSTER }}/g' kubernetes/external-secrets/*.yaml

            kubectl apply -f kubernetes/external-secrets/service-account.yaml
            kubectl apply -f kubernetes/external-secrets/secret-store.yaml
          fi

      - name: Deploy Network Policies
        run: |
          if [ -d "kubernetes/network-policies" ]; then
            echo "Deploying Network Policies..."
            kubectl apply -f kubernetes/network-policies/
          fi

      - name: Wait for Gateway to be ready
        run: |
          echo "Waiting for Gateway to be programmed..."
          kubectl wait --for=condition=Programmed gateway/servicetsunami-gateway \
            -n gateway-system \
            --timeout=300s || true

          echo "Gateway status:"
          kubectl get gateway -n gateway-system

      - name: Deployment Summary
        run: |
          echo "======================================"
          echo "Infrastructure Deployment Complete"
          echo "======================================"
          echo ""
          echo "Gateway IP: ${{ env.GATEWAY_IP }}"
          echo ""
          echo "DNS Records to configure:"
          echo "  servicetsunami.com     -> ${{ env.GATEWAY_IP }}"
          echo "  www.servicetsunami.com -> ${{ env.GATEWAY_IP }}"
          echo "  api.servicetsunami.com -> ${{ env.GATEWAY_IP }}"
          echo ""
          echo "Namespaces:"
          kubectl get namespaces -l app.kubernetes.io/name=servicetsunami
          echo ""
          echo "Gateway:"
          kubectl get gateway -n gateway-system
          echo ""
          echo "Secret Stores:"
          kubectl get secretstore -A
