# External Secrets Configuration for ServiceTsunami

This directory contains the External Secrets Operator configuration for syncing secrets from GCP Secret Manager.

## Prerequisites

1. **Install External Secrets Operator**
   ```bash
   helm repo add external-secrets https://charts.external-secrets.io
   helm install external-secrets external-secrets/external-secrets \
     --namespace external-secrets \
     --create-namespace \
     --set installCRDs=true
   ```

2. **Create GCP Service Account**
   ```bash
   # Create service account for External Secrets
   gcloud iam service-accounts create external-secrets \
     --display-name="External Secrets Operator" \
     --project=YOUR_GCP_PROJECT

   # Grant Secret Manager access
   gcloud projects add-iam-policy-binding YOUR_GCP_PROJECT \
     --member="serviceAccount:external-secrets@YOUR_GCP_PROJECT.iam.gserviceaccount.com" \
     --role="roles/secretmanager.secretAccessor"

   # Create Workload Identity binding
   gcloud iam service-accounts add-iam-policy-binding external-secrets@YOUR_GCP_PROJECT.iam.gserviceaccount.com \
     --role="roles/iam.workloadIdentityUser" \
     --member="serviceAccount:YOUR_GCP_PROJECT.svc.id.goog[prod/external-secrets-sa]"

   gcloud iam service-accounts add-iam-policy-binding external-secrets@YOUR_GCP_PROJECT.iam.gserviceaccount.com \
     --role="roles/iam.workloadIdentityUser" \
     --member="serviceAccount:YOUR_GCP_PROJECT.svc.id.goog[database/external-secrets-sa]"
   ```

3. **Create Secrets in GCP Secret Manager**
   ```bash
   # API secrets
   echo -n "your-jwt-secret-key" | gcloud secrets create servicetsunami-secret-key --data-file=-
   echo -n "postgresql://user:pass@host:5432/servicetsunami" | gcloud secrets create servicetsunami-database-url --data-file=-
   echo -n "sk-ant-api03-xxx" | gcloud secrets create servicetsunami-anthropic-api-key --data-file=-
   echo -n "your-mcp-api-key" | gcloud secrets create servicetsunami-mcp-api-key --data-file=-
   echo -n "your-internal-key" | gcloud secrets create servicetsunami-api-internal-key --data-file=-

   # Database secrets
   echo -n "your-postgres-password" | gcloud secrets create servicetsunami-postgres-password --data-file=-

   # Temporal secrets
   echo -n "temporal-postgres-password" | gcloud secrets create temporal-postgres-password --data-file=-
   echo -n "postgresql-host" | gcloud secrets create temporal-postgres-host --data-file=-
   ```

## Required Secrets

| Secret Name | Description | Used By |
|------------|-------------|---------|
| `servicetsunami-secret-key` | JWT signing key | API |
| `servicetsunami-database-url` | PostgreSQL connection string | API, Worker |
| `servicetsunami-anthropic-api-key` | Claude AI API key | API |
| `servicetsunami-mcp-api-key` | MCP server authentication | API, Worker |
| `servicetsunami-api-internal-key` | Service-to-service auth | API, Worker, MCP |
| `servicetsunami-postgres-password` | PostgreSQL password | PostgreSQL |
| `temporal-postgres-password` | Temporal DB password | Temporal |
| `temporal-postgres-host` | Temporal DB host | Temporal |

## Verification

```bash
# Check SecretStore status
kubectl get secretstore -n prod

# Check ExternalSecret sync status
kubectl get externalsecret -n prod

# View synced secrets
kubectl get secrets -n prod
```
